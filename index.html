<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏢 مكتب ماستر للاستشارات</title>
    <style>
        /* النمط العام للصفحة */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1, h2, h3 {
            margin: 0 0 15px 0;
        }

        /* شاشة تسجيل الدخول */
        .login-container {
            max-width: 450px;
            margin: 5% auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {opacity: 0; transform: translateY(-20px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .login-header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .login-form {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 15px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(52, 152, 219, 0.4);
        }

        .create-account-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }

        .create-account-btn {
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .create-account-btn:hover {
            box-shadow: 0 8px 15px rgba(39, 174, 96, 0.4);
        }

        /* الشاشة الرئيسية */
        .main-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {opacity: 0; transform: translateY(20px);}
            to {opacity: 1; transform: translateY(0);}
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filters-section {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-width: 150px;
            width: 100%;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #bd2130);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #d39e00);
            color: white;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        /* البطاقات الإحصائية */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border: 2px solid transparent;
        }

        .summary-card:hover {
            transform: translateY(-8px);
            border-color: #3498db;
        }

        .summary-card h3 {
            color: #495057;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        /* جدول البيانات */
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            border: 1px solid #dee2e6;
            padding: 12px 8px;
            text-align: center;
        }

        th {
            background: linear-gradient(135deg, #495057, #6c757d);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e3f2fd;
            transform: scale(1.005);
            transition: all 0.2s ease;
        }

        .status-cell {
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 20px;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-partial {
            background: #fff3cd;
            color: #856404;
        }

        .status-unpaid {
            background: #f8d7da;
            color: #721c24;
        }

        /* النوافذ المنبثقة */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            animation: modalSlideIn 0.4s ease-out;
        }

        @keyframes modalSlideIn {
            from {opacity: 0;transform: scale(0.8);}
            to {opacity: 1;transform: scale(1);}
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #e74c3c;
        }

        /* التنبيهات */
        .alert {
            padding: 15px;
            margin: 20px 0;
            border: 1px solid transparent;
            border-radius: 8px;
            font-weight: bold;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        /* التوافق مع الشاشات الصغيرة */
        @media (max-width: 768px) {
            .controls, .filters-section {
                flex-direction: column;
                align-items: stretch;
            }
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 8px 4px;
            }
            .header {
                flex-direction: column;
                text-align: center;
            }
            .header-right {
                justify-content: center;
            }
        }
    </style>
</head>
<body>

<!-- شاشة تسجيل الدخول -->
<div id="loginScreen" class="login-container">
    <div class="login-header">
        <h1>🏢 مكتب ماستر للاستشارات</h1>
        <p>نظام إدارة حسابات العملاء المتقدم</p>
    </div>
    <div class="login-form">
        <div id="loginAlert"></div>
        <form id="loginForm">
            <div class="form-group">
                <label>👤 اسم المستخدم:</label>
                <input type="text" id="loginUsername" required placeholder="أدخل اسم المستخدم">
            </div>
            <div class="form-group">
                <label>🔒 كلمة المرور:</label>
                <input type="password" id="loginPassword" required placeholder="أدخل كلمة المرور">
            </div>
            <button type="submit" class="login-btn">🚀 تسجيل الدخول</button>
        </form>
        <div class="create-account-section">
            <p>ليس لديك حساب؟</p>
            <button class="create-account-btn" onclick="showCreateAccount()">➕ إنشاء حساب جديد</button>
        </div>
    </div>
</div>

<!-- شاشة إنشاء الحساب -->
<div id="createAccountScreen" class="login-container hidden">
    <div class="login-header">
        <h1>📝 إنشاء حساب جديد</h1>
        <p>قم بإنشاء حساب إدارة جديد</p>
    </div>
    <div class="login-form">
        <div id="createAlert"></div>
        <form id="createAccountForm">
            <div class="form-group">
                <label>👤 اسم المستخدم:</label>
                <input type="text" id="createUsername" required placeholder="اختر اسم مستخدم">
            </div>
            <div class="form-group">
                <label>📧 البريد الإلكتروني:</label>
                <input type="email" id="createEmail" required placeholder="أدخل البريد الإلكتروني">
            </div>
            <div class="form-group">
                <label>🔒 كلمة المرور:</label>
                <input type="password" id="createPassword" required placeholder="اختر كلمة مرور قوية">
            </div>
            <div class="form-group">
                <label>🔒 تأكيد كلمة المرور:</label>
                <input type="password" id="confirmPassword" required placeholder="أعد إدخال كلمة المرور">
            </div>
            <button type="submit" class="login-btn">✅ إنشاء الحساب</button>
            <button type="button" class="login-btn btn-secondary" style="background: #6c757d; margin-top: 10px;" onclick="showLogin()">🔙 العودة لتسجيل الدخول</button>
        </form>
    </div>
</div>

<!-- الشاشة الرئيسية -->
<div id="mainScreen" class="main-container">
    <div class="header">
        <div class="header-left">
            <h1>📊 نظام إدارة حسابات العملاء المتقدم</h1>
            <p>إدارة شاملة ومتطورة لحسابات العملاء</p>
        </div>
        <div class="header-right">
            <div class="user-info">👋 مرحباً، <span id="currentUserName" style="font-weight: bold;"></span></div>
            <button class="logout-btn" onclick="logout()">🚪 تسجيل خروج</button>
        </div>
    </div>

    <!-- فلاتر البحث -->
    <div class="filters-section">
        <input type="text" id="searchFilter" class="filter-input" placeholder="🔍 البحث باسم العميل...">
        <select id="statusFilter" class="filter-input">
            <option value="">جميع الحالات</option>
            <option value="مدفوع">مدفوع</option>
            <option value="جزئي">جزئي</option>
            <option value="لم يدفع">لم يدفع</option>
        </select>
        <select id="paymentMethodFilter" class="filter-input">
            <option value="">جميع طرق الدفع</option>
            <option value="نقدي">نقدي</option>
            <option value="انستاباي">انستاباي</option>
            <option value="فودافون كاش">فودافون كاش</option>
        </select>
        <button class="btn btn-primary" onclick="updateWorkersTable()">🔍 تطبيق الفلاتر</button>
        <button class="btn btn-warning" onclick="clearFilters()">🔄 مسح الفلاتر</button>
    </div>

    <!-- أزرار التحكم -->
    <div class="filters-section">
        <button class="btn btn-success" onclick="addWorker()">➕ إضافة عميل جديد</button>
        <button class="btn btn-primary" onclick="exportToExcel()">📥 تصدير إكسل</button>
        <button class="btn btn-primary" onclick="exportToJSON()">💾 تصدير JSON</button>
        <button class="btn btn-danger" onclick="clearAll()">🗑️ مسح الكل</button>
    </div>

    <!-- إحصائيات النظام -->
    <div class="summary-cards">
        <div class="summary-card">
            <div class="icon">👥</div>
            <h3>إجمالي العملاء</h3>
            <div class="value" id="totalWorkers">0</div>
        </div>
        <div class="summary-card">
            <div class="icon">📋</div>
            <h3>إجمالي التقارير</h3>
            <div class="value" id="totalReports">0</div>
        </div>
        <div class="summary-card">
            <div class="icon">💰</div>
            <h3>إجمالي الحساب</h3>
            <div class="value" id="totalAmount">0 جنيه</div>
        </div>
        <div class="summary-card">
            <div class="icon">✅</div>
            <h3>إجمالي المدفوع</h3>
            <div class="value" id="totalPaid">0 جنيه</div>
        </div>
        <div class="summary-card">
            <div class="icon">💸</div>
            <h3>إجمالي العمولة</h3>
            <div class="value" id="totalCommission">0 جنيه</div>
        </div>
        <div class="summary-card">
            <div class="icon">💵</div>
            <h3>صافي المدفوع</h3>
            <div class="value" id="totalNetPaid">0 جنيه</div>
        </div>
        <div class="summary-card">
            <div class="icon">⏳</div>
            <h3>إجمالي المتبقي</h3>
            <div class="value" id="totalRemaining">0 جنيه</div>
        </div>
        <div class="summary-card">
            <div class="icon">📈</div>
            <h3>معدل التحصيل</h3>
            <div class="value" id="collectionRate">0%</div>
        </div>
    </div>

    <!-- جدول البيانات -->
    <div class="table-container">
        <table id="workersTable">
            <thead>
                <tr>
                    <th>اسم العميل</th>
                    <th>عدد التقارير</th>
                    <th>سعر التقرير (جنيه)</th>
                    <th>إجمالي الحساب (جنيه)</th>
                    <th>المبلغ المدفوع (جنيه)</th>
                    <th>طريقة الدفع</th>
                    <th>عمولة السحب (جنيه)</th>
                    <th>صافي المدفوع (جنيه)</th>
                    <th>المتبقي (جنيه)</th>
                    <th>حالة الدفع</th>
                    <th>تاريخ الإضافة</th>
                    <th>إجراءات</th>
                </tr>
            </thead>
            <tbody id="workersTableBody"></tbody>
            <tfoot>
                <tr class="total-row">
                    <td><strong>الإجمالي</strong></td>
                    <td><strong id="totalReportsFooter">0</strong></td>
                    <td>-</td>
                    <td><strong id="totalAmountFooter">0 جنيه</strong></td>
                    <td><strong id="totalPaidFooter">0 جنيه</strong></td>
                    <td>-</td>
                    <td><strong id="totalCommissionFooter">0 جنيه</strong></td>
                    <td><strong id="totalNetPaidFooter">0 جنيه</strong></td>
                    <td><strong id="totalRemainingFooter">0 جنيه</strong></td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- نموذج إضافة عميل جديد -->
<div id="workerModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>➕ إضافة عميل جديد</h2>
        <form id="workerForm" style="margin-top: 20px;">
            <div style="margin-bottom: 15px;">
                <label>اسم العميل:</label>
                <input type="text" id="workerName" required style="margin-top: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label>عدد التقارير:</label>
                <input type="number" id="reportCount" min="0" required style="margin-top: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label>سعر التقرير (جنيه):</label>
                <input type="number" id="reportPrice" min="0" required style="margin-top: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label>المبلغ المدفوع (جنيه):</label>
                <input type="number" id="paidAmount" min="0" value="0" style="margin-top: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label>طريقة الدفع:</label>
                <select id="paymentMethod" style="margin-top: 5px; width: 100%; padding: 8px;">
                    <option value="نقدي">نقدي</option>
                    <option value="انستاباي">انستاباي</option>
                    <option value="فودافون كاش">فودافون كاش</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success" style="width: 100%;">✅ إضافة العميل</button>
        </form>
    </div>
</div>

<!-- نموذج تعديل بيانات العميل -->
<div id="workerEditModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>✏️ تعديل بيانات العميل</h2>
        <form id="workerEditForm" style="margin-top: 20px;">
            <input type="hidden" id="workerId">
            <div style="margin-bottom: 15px;">
                <label>اسم العميل:</label>
                <input type="text" id="workerNameEdit" required style="margin-top: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label>عدد التقارير:</label>
                <input type="number" id="reportCountEdit" min="0" required style="margin-top: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label>سعر التقرير (جنيه):</label>
                <input type="number" id="reportPriceEdit" min="0" required style="margin-top: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label>المبلغ المدفوع (جنيه):</label>
                <input type="number" id="paidAmountEdit" min="0" value="0" style="margin-top: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label>طريقة الدفع:</label>
                <select id="paymentMethodEdit" style="margin-top: 5px; width: 100%; padding: 8px;">
                    <option value="نقدي">نقدي</option>
                    <option value="انستاباي">انستاباي</option>
                    <option value="فودافون كاش">فودافون كاش</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success" style="width: 100%;">✅ حفظ التعديلات</button>
        </form>
    </div>
</div>

<!-- منطقة التنبيهات -->
<div id="createAlert" style="padding: 20px;"></div>

<script>
    // نظام إدارة البيانات والمستخدمين
    class DataManager {
        constructor() {
            this.users = this.loadUsers();
            this.currentUser = null;
            this.userData = {};
        }

        loadUsers() {
            return JSON.parse(localStorage.getItem('masterOfficeUsers') || '{}');
        }

        saveUsers() {
            localStorage.setItem('masterOfficeUsers', JSON.stringify(this.users));
        }

        createAccount(username, email, password) {
            if (this.users[username]) {
                return { success: false, message: 'اسم المستخدم موجود بالفعل' };
            }
            this.users[username] = {
                email: email,
                password: password,
                workers: []
            };
            this.saveUsers();
            return { success: true, message: 'تم إنشاء الحساب بنجاح' };
        }

        login(username, password) {
            const user = this.users[username];
            if (!user || user.password !== password) {
                return { success: false, message: 'اسم المستخدم أو كلمة المرور غير صحيحة' };
            }
            this.currentUser = username;
            this.userData = user;
            return { success: true, message: 'تم تسجيل الدخول بنجاح' };
        }

        logout() {
            this.currentUser = null;
            this.userData = {};
        }

        getCurrentUser() {
            return this.currentUser ? {
                username: this.currentUser,
                ...this.userData
            } : null;
        }

        addWorker(workerData) {
            if (!this.currentUser) return { success: false, message: 'لم يتم تسجيل الدخول' };
            if (!workerData.name || !workerData.reportCount || !workerData.reportPrice) {
                return { success: false, message: 'الرجاء ملء جميع الحقول' };
            }
            const worker = {
                id: Date.now(),
                name: workerData.name,
                reportCount: parseFloat(workerData.reportCount),
                reportPrice: parseFloat(workerData.reportPrice),
                paidAmount: parseFloat(workerData.paidAmount) || 0,
                paymentMethod: workerData.paymentMethod || "نقدي",
                createdAt: new Date().toISOString()
            };
            this.users[this.currentUser].workers.push(worker);
            this.saveUsers();
            this.userData = this.users[this.currentUser];
            return { success: true, message: 'تم إضافة العميل بنجاح' };
        }

        updateWorker(workerId, workerData) {
            if (!this.currentUser) return { success: false, message: 'لم يتم تسجيل الدخول' };
            const workers = [...this.userData.workers];
            const workerIndex = workers.findIndex(w => w.id === workerId);
            if (workerIndex === -1) return { success: false, message: 'العميل غير موجود' };

            workers[workerIndex] = {
                ...workers[workerIndex],
                name: workerData.name,
                reportCount: parseFloat(workerData.reportCount) || 0,
                reportPrice: parseFloat(workerData.reportPrice) || 0,
                paidAmount: parseFloat(workerData.paidAmount) || 0,
                paymentMethod: workerData.paymentMethod || "نقدي"
            };

            this.users[this.currentUser].workers = workers;
            this.userData = this.users[this.currentUser];
            this.saveUsers();

            return { success: true, message: 'تم تحديث بيانات العميل بنجاح' };
        }

        deleteWorker(workerId) {
            if (!this.currentUser) return { success: false, message: 'لم يتم تسجيل الدخول' };
            this.users[this.currentUser].workers = this.userData.workers.filter(w => w.id !== workerId);
            this.userData = this.users[this.currentUser];
            this.saveUsers();
            return { success: true, message: 'تم حذف العميل بنجاح' };
        }

        getFilteredWorkers(filters = {}) {
            if (!this.currentUser) return [];
            let result = [...this.userData.workers];

            if (filters.search && filters.search.trim()) {
                const search = filters.search.toLowerCase().trim();
                result = result.filter(worker => worker.name.toLowerCase().includes(search));
            }

            if (filters.status) {
                result = result.filter(worker => {
                    const total = worker.reportCount * worker.reportPrice;
                    const paid = worker.paidAmount;
                    if (filters.status === 'مدفوع') return paid >= total;
                    if (filters.status === 'جزئي') return paid > 0 && paid < total;
                    if (filters.status === 'لم يدفع') return paid <= 0;
                    return true;
                });
            }

            if (filters.paymentMethod) {
                result = result.filter(worker => worker.paymentMethod === filters.paymentMethod);
            }

            return result;
        }

        clearAllWorkers() {
            if (!this.currentUser) return { success: false, message: 'لم يتم تسجيل الدخول' };
            if (window.confirm('هل أنت متأكد من رغبتك في مسح كل البيانات؟')) {
                this.users[this.currentUser].workers = [];
                this.userData = this.users[this.currentUser];
                this.saveUsers();
                return { success: true, message: 'تم مسح كل البيانات بنجاح' };
            }
            return { success: false, message: 'تم إلغاء عملية المسح' };
        }
    }

    const dataManager = new DataManager();

    function showCreateAccount() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('createAccountScreen').classList.remove('hidden');
        document.getElementById('createAccountScreen').style.display = 'block';
    }

    function showLogin() {
        document.getElementById('createAccountScreen').classList.add('hidden');
        document.getElementById('createAccountScreen').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'block';
    }

    function showAlert(elementId, message, isSuccess = true) {
        const alertDiv = document.getElementById(elementId);
        alertDiv.innerHTML = `
            <div class="alert ${isSuccess ? 'alert-success' : 'alert-error'}">${message}</div>
        `;
        setTimeout(() => {
            alertDiv.innerHTML = '';
        }, 5000);
    }

    // تسجيل الدخول
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        const result = dataManager.login(username, password);
        if (result.success) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('currentUserName').textContent = username;
            updateWorkersTable();
        } else {
            showAlert('loginAlert', result.message, false);
        }
    });

    // إنشاء حساب
    document.getElementById('createAccountForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('createUsername').value.trim();
        const email = document.getElementById('createEmail').value.trim();
        const password = document.getElementById('createPassword').value.trim();
        const confirmPassword = document.getElementById('confirmPassword').value.trim();
        if (password !== confirmPassword) {
            showAlert('createAlert', 'كلمتا المرور غير متطابقتين', false);
            return;
        }
        const result = dataManager.createAccount(username, email, password);
        if (result.success) {
            showAlert('createAlert', result.message, true);
            setTimeout(() => {
                showLogin();
            }, 2000);
        } else {
            showAlert('createAlert', result.message, false);
        }
    });

    // تسجيل الخروج
    function logout() {
        if (window.confirm('هل أنت متأكد من رغبتك في تسجيل الخروج؟')) {
            dataManager.logout();
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }
    }

    // إضافة عميل جديد
    function addWorker() {
        document.getElementById('workerName').value = '';
        document.getElementById('reportCount').value = 0;
        document.getElementById('reportPrice').value = 0;
        document.getElementById('paidAmount').value = 0;
        document.getElementById('paymentMethod').value = 'نقدي';
        document.getElementById('workerModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('workerModal').style.display = 'none';
    }

    document.getElementById('workerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const workerData = {
            name: document.getElementById('workerName').value.trim(),
            reportCount: document.getElementById('reportCount').value,
            reportPrice: document.getElementById('reportPrice').value,
            paidAmount: document.getElementById('paidAmount').value,
            paymentMethod: document.getElementById('paymentMethod').value
        };
        const result = dataManager.addWorker(workerData);
        if (result.success) {
            showAlert('createAlert', result.message, true);
            closeModal();
            updateWorkersTable();
        } else {
            showAlert('createAlert', result.message, false);
        }
    });
function exportToExcel() {
    const table = document.getElementById("workersTable");
    const htmlTable = table.cloneNode(true); // نسخ الجدول الأصلي
    const newHeader = document.createElement("tr");

    // إضافة صف عنوان أعلى الجدول
    const titleCell = document.createElement("td");
    titleCell.setAttribute("colspan", table.rows[0].cells.length);
    titleCell.textContent = "مكتب ماستر للاستشارات - تقرير العملاء";
    titleCell.style.fontSize = "16px";
    titleCell.style.fontWeight = "bold";
    titleCell.style.textAlign = "center";

    const headerRow = htmlTable.querySelector("thead tr");
    headerRow.parentNode.insertBefore(newHeader, headerRow);
    const titleRow = document.createElement("tr");
    const titleCellWrapper = document.createElement("td");
    titleCellWrapper.setAttribute("colspan", table.rows[0].cells.length);
    titleCellWrapper.appendChild(titleCell);
    titleRow.appendChild(titleCellWrapper);
    headerRow.parentNode.insertBefore(titleRow, headerRow);

    // إضافة تاريخ التصدير
    const dateRow = document.createElement("tr");
    const dateCell = document.createElement("td");
    dateCell.setAttribute("colspan", table.rows[0].cells.length);
    dateCell.textContent = `تاريخ التصدير: ${new Date().toLocaleString()}`;
    dateCell.style.fontSize = "12px";
    dateCell.style.color = "#888";
    dateRow.appendChild(dateCell);
    headerRow.parentNode.insertBefore(dateRow, headerRow.nextSibling);

    // تحويل الجدول إلى ورقة عمل Excel
    const ws = XLSX.utils.table_to_sheet(htmlTable);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "تقرير العملاء");
    XLSX.writeFile(wb, `تقرير_العملاء_${new Date().toISOString().split('T')[0]}.xlsx`);
}
    // تعديل العميل
    function editWorker(workerId) {
        const currentUser = dataManager.getCurrentUser();
        if (!currentUser) return;

        const worker = currentUser.workers.find(w => w.id === workerId);
        if (!worker) {
            showAlert('createAlert', 'العميل غير موجود', false);
            return;
        }

        document.getElementById('workerId').value = worker.id;
        document.getElementById('workerNameEdit').value = worker.name;
        document.getElementById('reportCountEdit').value = worker.reportCount;
        document.getElementById('reportPriceEdit').value = worker.reportPrice;
        document.getElementById('paidAmountEdit').value = worker.paidAmount;
        document.getElementById('paymentMethodEdit').value = worker.paymentMethod;

        document.getElementById('workerEditModal').style.display = 'block';
    }

    function closeEditModal() {
        document.getElementById('workerEditModal').style.display = 'none';
    }

    document.getElementById('workerEditForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const workerData = {
            id: parseInt(document.getElementById('workerId').value),
            name: document.getElementById('workerNameEdit').value.trim(),
            reportCount: document.getElementById('reportCountEdit').value,
            reportPrice: document.getElementById('reportPriceEdit').value,
            paidAmount: document.getElementById('paidAmountEdit').value,
            paymentMethod: document.getElementById('paymentMethodEdit').value
        };

        const result = dataManager.updateWorker(workerData.id, workerData);
        if (result.success) {
            showAlert('createAlert', result.message, true);
            closeEditModal();
            updateWorkersTable();
        } else {
            showAlert('createAlert', result.message, false);
        }
    });

    // حذف العميل
    function deleteWorker(workerId) {
        if (window.confirm('هل أنت متأكد من رغبتك في حذف هذا العميل؟')) {
            const result = dataManager.deleteWorker(workerId);
            if (result.success) {
                showAlert('createAlert', result.message, true);
                updateWorkersTable();
            } else {
                showAlert('createAlert', result.message, false);
            }
        }
    }

    // تحديث الجدول
    function updateWorkersTable() {
        const currentUserData = dataManager.getCurrentUser();
        if (!currentUserData) return;

        const filters = {
            search: document.getElementById('searchFilter').value,
            status: document.getElementById('statusFilter').value,
            paymentMethod: document.getElementById('paymentMethodFilter').value
        };

        const workers = dataManager.getFilteredWorkers(filters);

        const tableBody = document.getElementById('workersTableBody');
        tableBody.innerHTML = '';

        let totalReports = 0;
        let totalAmount = 0;
        let totalPaid = 0;
        let totalCommission = 0;
        let totalNetPaid = 0;
        let totalRemaining = 0;

        workers.forEach(worker => {
            const amount = worker.reportCount * worker.reportPrice;
            const paid = worker.paidAmount;
            const remaining = amount - paid;

            let commission = 0;
            if (worker.paymentMethod === 'انستاباي') commission = paid * 0.00;
            if (worker.paymentMethod === 'فودافون كاش') commission = paid * 0.01;
            const netPaid = paid - commission;

            totalReports += parseInt(worker.reportCount);
            totalAmount += amount;
            totalPaid += paid;
            totalCommission += commission;
            totalNetPaid += netPaid;
            totalRemaining += remaining;

            let statusClass = '';
            if (paid >= amount) statusClass = 'status-paid';
            else if (paid > 0) statusClass = 'status-partial';
            else statusClass = 'status-unpaid';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${worker.name}</td>
                <td>${worker.reportCount}</td>
                <td>${worker.reportPrice.toFixed(2)}</td>
                <td>${amount.toFixed(2)}</td>
                <td>${worker.paidAmount.toFixed(2)}</td>
                <td>${worker.paymentMethod}</td>
                <td class="commission-cell">${commission.toFixed(2)}</td>
                <td class="net-paid-cell">${netPaid.toFixed(2)}</td>
                <td class="${remaining > 0 ? 'commission-cell' : ''}">${remaining.toFixed(2)}</td>
                <td><div class="status-cell ${statusClass}">${paid >= amount ? 'مدفوع' : paid > 0 ? 'جزئي' : 'لم يدفع'}</div></td>
                <td>${new Date(worker.createdAt).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-warning" style="padding: 4px 8px; font-size: 12px;" onclick="editWorker(${worker.id})">✏️ تعديل</button>
                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 12px; margin-left: 5px;" onclick="deleteWorker(${worker.id})">❌ حذف</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        document.getElementById('totalReportsFooter').innerHTML = `<strong>${totalReports}</strong>`;
        document.getElementById('totalAmountFooter').innerHTML = `<strong>${totalAmount.toFixed(2)}</strong>`;
        document.getElementById('totalPaidFooter').innerHTML = `<strong>${totalPaid.toFixed(2)}</strong>`;
        document.getElementById('totalCommissionFooter').innerHTML = `<strong>${totalCommission.toFixed(2)}</strong>`;
        document.getElementById('totalNetPaidFooter').innerHTML = `<strong>${totalNetPaid.toFixed(2)}</strong>`;
        document.getElementById('totalRemainingFooter').innerHTML = `<strong>${totalRemaining.toFixed(2)}</strong>`;
        document.getElementById('totalWorkers').textContent = workers.length;
        document.getElementById('totalReports').textContent = totalReports;
        document.getElementById('totalAmount').textContent = `${totalAmount.toFixed(2)} جنيه`;
        document.getElementById('totalPaid').textContent = `${totalPaid.toFixed(2)} جنيه`;
        document.getElementById('totalCommission').textContent = `${totalCommission.toFixed(2)} جنيه`;
        document.getElementById('totalNetPaid').textContent = `${totalNetPaid.toFixed(2)} جنيه`;
        document.getElementById('totalRemaining').textContent = `${totalRemaining.toFixed(2)} جنيه`;
        document.getElementById('collectionRate').textContent = totalAmount > 0 ? ((totalPaid / totalAmount) * 100).toFixed(1) + '%' : '0%';
    }

    // مسح الكل
    function clearAll() {
        if (window.confirm('هل أنت متأكد من رغبتك في مسح كل البيانات؟')) {
            dataManager.clearAllWorkers();
            updateWorkersTable();
        }
    }

    // تطبيق الفلاتر
    function applyFilters() {
        updateWorkersTable();
    }

    function clearFilters() {
        document.getElementById('searchFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('paymentMethodFilter').value = '';
        updateWorkersTable();
    }

    // عند تحميل الصفحة
    window.onload = function () {
        const currentUser = dataManager.getCurrentUser();
        if (currentUser) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser.username;
            updateWorkersTable();
        }
    };
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script> 
</body>
</html>
